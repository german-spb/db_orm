import psycopg2
import sqlalchemy
from sqlalchemy.orm import sessionmaker
from models import create_tables, Publisher, Book, Shop, Stock, Sale

DSN = 'postgresql://german:gkoretskiy27@localhost:5432/bookshops'
engine = sqlalchemy.create_engine(DSN)
Session = sessionmaker(bind=engine)
session = Session()
create_tables(engine)

pub1 = Publisher(name='Пушкин')
pub2 = Publisher(name='Достоевский')
pub3 = Publisher(name='Толстой')
pub4 = Publisher(name='Лермонтов')
pub5 = Publisher(name='Чехов')
session.add_all([pub1,pub2,pub3,pub4,pub5])
session.commit()
shop1 = Shop(name='Буквоед')
shop2 = Shop(name='Лабиринт')
shop3 = Shop(name='Книжный дом')
shop4 = Shop(name='Читай')
session.add_all([shop1, shop2, shop3, shop4])
session.commit()
book1 = Book(title='Капитанская дочка',publisher=pub1)
book2 = Book(title='Руслан и Людмила', publisher=pub1)
book3 = Book(title='Евгений Онегин', publisher=pub1)
book4 = Book(title='Война и мир', publisher=pub3)
book5 = Book(title='Каштанка', publisher=pub5)
book6 = Book(title='Идиот', publisher=pub2)
book7 = Book(title='Бородино', publisher=pub4)
session.add_all([book1,book2,book3,book4,book5,book6,book7])
session.commit()
st1 = Stock(book=book1,shop=shop1,count=12)
st2 = Stock(book=book2,shop=shop1,count=15)
st3 = Stock(book=book2,shop=shop2,count=22)
st4 = Stock(book=book2,shop=shop3,count=23)
st5 = Stock(book=book3,shop=shop2,count=19)
st6 = Stock(book=book4,shop=shop1,count=40)
st7 = Stock(book=book4,shop=shop4,count=24)
st8 = Stock(book=book5,shop=shop3,count=23)
st9 = Stock(book=book6,shop=shop4,count=32)
st10 = Stock(book=book7,shop=shop3,count=28)
st11 = Stock(book=book7,shop=shop2,count=19)
session.add_all([st1,st2,st3,st4,st5,st6,st7,st8,st9,st10,st11])
session.commit()
sale1 = Sale(price=501, date_sale='2022-12-02', stock=st1, count=3)
sale2 = Sale(price=600, date_sale='2022-12-03', stock=st2, count=1)
sale3 = Sale(price=450, date_sale='2022-12-04', stock=st4, count=2)
sale4 = Sale(price=480, date_sale='2022-12-05', stock=st3, count=2)
sale5 = Sale(price=540, date_sale='2022-12-06', stock=st1, count=2)
sale6 = Sale(price=600, date_sale='2022-12-07', stock=st2, count=2)
sale7 = Sale(price=399, date_sale='2022-12-01', stock=st10, count=3)
sale8 = Sale(price=866, date_sale='2022-11-27', stock=st6, count=3)
sale9 = Sale(price=905, date_sale='2022-11-30', stock=st7, count=3)
sale10 = Sale(price=1002, date_sale='2022-12-06', stock=st11, count=3)
sale11 = Sale(price=777, date_sale='2022-12-25', stock=st5, count=3)
sale12 = Sale(price=967, date_sale='2022-11-15', stock=st9, count=3)
sale13 = Sale(price=933, date_sale='2022-11-20', stock=st8, count=3)
session.add_all([sale1, sale2, sale3, sale4, sale5, sale6, sale7, sale8, sale9, sale10, sale11,sale12, sale13])
session.commit()

if __name__ == '__main__':
   writ = input('Введите имя писателя: ')
   subq = session.query(Publisher).filter(Publisher.name == writ).subquery()
   subq2 = session.query(Book).join(subq, Book.id_publisher == subq.c.id).subquery()
   subq3 = session.query(Stock).join(subq2, Stock.id_book == subq2.c.id).subquery()
   subq4 = session.query(Sale).join(subq3, Sale.id_stock == subq3.c.id)
   for b in subq4.all():
      print(f'{b.stock.book} | {b.stock.shop} | {b.price} | {b.date_sale}')

session.close()
